<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/" />
    </ion-buttons>
    <ion-title>Pending User Approvals</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="console-page">
    <section class="console-hero">
      <div>
        <p class="console-eyebrow">Access Control</p>
        <h1>User approvals</h1>
        <p>
          Review incoming users, assign the right hotel or hotel-group scope, and keep access
          limited to the right level of the hierarchy.
        </p>
      </div>
      <div class="console-meta">
        <span class="console-pill">{{ pendingUsers().length }} pending user(s)</span>
      </div>
    </section>

    <ion-card class="console-card">
      <ion-card-header>
        <ion-card-title>Pending App Users</ion-card-title>
        <p class="section-copy">Only approvals inside your role scope are shown here.</p>
      </ion-card-header>
      <ion-card-content>
        <div class="console-toolbar">
          <div class="console-meta">
            <span class="console-pill">Role-aware approval queue</span>
          </div>
          <div class="form-actions">
            <ion-button type="button" fill="clear" (click)="refreshAll()">Refresh</ion-button>
          </div>
        </div>

        @if (error()) {
          <p class="error-text">{{ error() }}</p>
        }
        @if (loading()) {
          <p class="empty-text">Loading...</p>
        } @else {
          <div class="console-list">
            @for (user of pendingUsers(); track user.id ?? user.firebaseUid) {
              <article class="console-record">
                <h3>{{ user.name }}</h3>
                <p>{{ user.email }}</p>
                <div class="record-metadata">
                  <span class="console-pill">
                    Requested Group: {{ user.requestedHotelGroup?.name || '-' }}
                  </span>
                  <span class="console-pill">
                    Requested Hotel: {{ user.requestedHotel?.name || '-' }}
                  </span>
                </div>

                @if (user.id != null) {
                  <div class="approval-grid">
                    <ion-item class="field-item">
                      <ion-label position="stacked">Role</ion-label>
                      <ion-select
                        [(ngModel)]="drafts[user.id].accessRole"
                        [ngModelOptions]="{ standalone: true }"
                        (ngModelChange)="onRoleChange(user.id)"
                        interface="alert"
                      >
                        @for (role of roleOptionsForUser(user); track role) {
                          <ion-select-option [value]="role">{{ role }}</ion-select-option>
                        }
                      </ion-select>
                    </ion-item>

                    @if (needsGroupAssignment(drafts[user.id].accessRole)) {
                      <ion-item class="field-item">
                        <ion-label position="stacked">Assign Hotel Group</ion-label>
                        <ion-select
                          [(ngModel)]="drafts[user.id].assignedHotelGroupId"
                          [ngModelOptions]="{ standalone: true }"
                          interface="alert"
                        >
                          <ion-select-option [value]="null">Select group</ion-select-option>
                          @for (group of assignableHotelGroups(); track group.id ?? group.name) {
                            <ion-select-option [value]="group.id ?? null">
                              {{ group.name }}{{ group.code ? ' (' + group.code + ')' : '' }}
                            </ion-select-option>
                          }
                        </ion-select>
                      </ion-item>
                    }

                    @if (needsHotelAssignment(drafts[user.id].accessRole)) {
                      <ion-item class="field-item">
                        <ion-label position="stacked">Assign Hotel</ion-label>
                        <ion-select
                          [(ngModel)]="drafts[user.id].assignedHotelId"
                          [ngModelOptions]="{ standalone: true }"
                          interface="alert"
                        >
                          <ion-select-option [value]="null">Select hotel</ion-select-option>
                          @for (hotel of filteredHotelsForUser(user.id); track hotel.id ?? hotel.name) {
                            <ion-select-option [value]="hotel.id ?? null">
                              {{ hotel.name }}{{ hotel.code ? ' (' + hotel.code + ')' : '' }}
                            </ion-select-option>
                          }
                        </ion-select>
                      </ion-item>
                    }

                    @if (needsEmployeeRole(drafts[user.id].accessRole)) {
                      <ion-item class="field-item">
                        <ion-label position="stacked">Operational Role</ion-label>
                        <ion-select
                          [(ngModel)]="drafts[user.id].employeeRole"
                          [ngModelOptions]="{ standalone: true }"
                          interface="alert"
                        >
                          <ion-select-option [value]="null">Select role</ion-select-option>
                          @for (role of employeeRoles; track role) {
                            <ion-select-option [value]="role">{{ role.replaceAll('_', ' ') }}</ion-select-option>
                          }
                        </ion-select>
                      </ion-item>
                    }

                    <ion-item class="checkbox-item">
                      <ion-checkbox
                        slot="start"
                        type="checkbox"
                        [(ngModel)]="drafts[user.id].active"
                        [ngModelOptions]="{ standalone: true }"
                      />
                      <ion-label>Active after approval</ion-label>
                    </ion-item>

                    <div class="form-actions span-2">
                      <ion-button type="button" [disabled]="isBusy(user.id)" (click)="approve(user)">
                        Approve
                      </ion-button>
                      <ion-button
                        type="button"
                        fill="outline"
                        color="danger"
                        [disabled]="isBusy(user.id)"
                        (click)="reject(user)"
                      >
                        Reject
                      </ion-button>
                    </div>
                  </div>
                }
              </article>
            } @empty {
              <p class="empty-text">No pending users.</p>
            }
          </div>
        }
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
