<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/" />
    </ion-buttons>
    <ion-title>Requests</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="console-page">
    <section class="console-hero">
      <div>
        <p class="console-eyebrow">Operations Board</p>
        <h1>Requests</h1>
        <p>
          Work through active guest needs without the old CRUD form. Filter the queue, open a request,
          and move it forward with one tap.
        </p>
      </div>
      <div class="console-meta">
        <span class="console-pill">{{ requestCounts().ALL }} total</span>
        <span class="console-pill">{{ requestCounts().NEW }} new</span>
        <span class="console-pill">{{ requestCounts().ACCEPTED }} active</span>
      </div>
    </section>

    <ion-card class="console-card">
      <ion-card-header>
        <ion-card-title>Queue</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="request-filter-grid" role="tablist" aria-label="Request filters">
          @for (filter of boardFilters; track filter) {
            <button
              type="button"
              class="request-filter-tile"
              [class.is-active]="activeFilter() === filter"
              (click)="setFilter(filter)"
            >
              <span>{{ filterLabel(filter) }}</span>
              <strong>{{ requestCounts()[filter] }}</strong>
            </button>
          }
        </div>

        @if (error()) {
          <p class="error-text">{{ error() }}</p>
        }

        @if (loading()) {
          <p class="empty-text">Loading requests...</p>
        } @else {
          <div class="request-board">
            @for (item of filteredItems(); track item.id ?? $index) {
              <button
                type="button"
                class="request-card"
                [class.is-selected]="selectedRequest()?.id === item.id"
                [class.status-new]="item.status === 'NEW'"
                [class.status-accepted]="item.status === 'ACCEPTED'"
                [class.status-completed]="item.status === 'COMPLETED'"
                [class.status-cancelled]="item.status === 'CANCELLED'"
                (click)="openRequest(item)"
              >
                <div class="request-card-head">
                  <div class="request-primary">
                    <div class="request-room-badge">
                      <strong class="request-room">{{ item.room?.number || '?' }}</strong>
                      @if (item.room?.floor != null) {
                        <span class="request-floor">F{{ item.room?.floor }}</span>
                      }
                    </div>
                    <div class="request-title-block">
                      <span class="request-location">{{ item.hotel?.name || 'Hotel' }}</span>
                      <span class="request-type">{{ typeLabel(item) }}</span>
                    </div>
                  </div>
                  <div class="request-chip-row">
                    <span class="request-chip request-status-chip">{{ statusLabel(item) }}</span>
                  </div>
                </div>

                <div class="request-card-details">
                  <span><strong>Assignee:</strong> {{ assigneeName(item) }}</span>
                  <p class="request-comment-line"><strong>Comment:</strong> {{ item.message || 'No guest note provided.' }}</p>
                  <span><strong>{{ elapsedMetricLabel(item) }}:</strong> {{ elapsedMetricValue(item) }}</span>
                  <span class="request-primary-time"><strong>{{ primaryTimeHeading(item) }}:</strong> {{ primaryTimeLabel(item) }}</span>
                </div>

                <div class="request-card-actions">
                  @if (canAccept(item)) {
                    <ion-button size="small" (click)="$event.stopPropagation(); accept(item)" [disabled]="acting()">
                      Accept
                    </ion-button>
                  }
                  @if (canComplete(item)) {
                    <ion-button
                      size="small"
                      fill="outline"
                      (click)="$event.stopPropagation(); complete(item)"
                      [disabled]="acting()"
                    >
                      Complete
                    </ion-button>
                  }
                  @if (canReopen(item)) {
                    <ion-button
                      size="small"
                      fill="outline"
                      color="medium"
                      (click)="$event.stopPropagation(); reopen(item)"
                      [disabled]="acting()"
                    >
                      Reopen
                    </ion-button>
                  }
                  <ion-button size="small" fill="clear" (click)="$event.stopPropagation(); openRequest(item)">
                    View
                  </ion-button>
                </div>
              </button>
            } @empty {
              <div class="request-empty-state">
                <p>No requests in this view.</p>
                <ion-button fill="outline" (click)="refreshAll()">Refresh</ion-button>
              </div>
            }
          </div>
        }
      </ion-card-content>
    </ion-card>

    @if (selectedRequest(); as item) {
      <div class="request-popup-overlay" (click)="closeRequest()">
        <section class="request-popup-card" (click)="$event.stopPropagation()">
          <div class="request-popup-head">
            <div>
              <p class="console-eyebrow">Request Detail</p>
              <h3>{{ item.hotel?.name || 'Hotel' }} â€¢ Room {{ item.room?.number || '?' }}</h3>
            </div>
            <ion-button fill="clear" size="small" (click)="closeRequest()">Close</ion-button>
          </div>

          <div class="request-popup-status">
            <span class="request-chip request-status-chip">{{ statusLabel(item) }}</span>
            <span class="request-chip">{{ typeLabel(item) }}</span>
          </div>

          <div class="request-detail-grid">
            <div class="request-detail-block">
              <span>Assignee</span>
              <strong class="request-assignee-name">{{ assigneeName(item) }}</strong>
              <small class="request-assignee-role">{{ assigneeRole(item) }}</small>
            </div>
            <div class="request-detail-block">
              <span>Request Type</span>
              <strong>{{ typeLabel(item) }}</strong>
            </div>
            <div class="request-detail-block span-2">
              <span>Guest Note</span>
              <p>{{ item.message || 'No guest note provided.' }}</p>
            </div>
            <div class="request-detail-block">
              <span>Created At</span>
              <strong>{{ dateTimeLabel(item.createdAt) }}</strong>
            </div>
            <div class="request-detail-block">
              <span>Accepted At</span>
              <strong>{{ dateTimeLabel(item.acceptedAt) }}</strong>
            </div>
            <div class="request-detail-block">
              <span>Completed At</span>
              <strong>{{ dateTimeLabel(item.completedAt) }}</strong>
            </div>
            @if (item.comments) {
              <div class="request-detail-block span-2">
                <span>Internal Comments</span>
                <p>{{ item.comments }}</p>
              </div>
            }
          </div>

          <div class="request-popup-actions">
            @if (canAccept(item)) {
              <ion-button (click)="accept(item)" [disabled]="acting()">Accept Request</ion-button>
            }
            @if (canComplete(item)) {
              <ion-button fill="outline" (click)="complete(item)" [disabled]="acting()">Mark Complete</ion-button>
            }
            @if (canReopen(item)) {
              <ion-button fill="outline" color="medium" (click)="reopen(item)" [disabled]="acting()">
                Reopen
              </ion-button>
            }
          </div>
        </section>
      </div>
    }
  </div>
</ion-content>
