<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/" />
    </ion-buttons>
    <ion-title>Staff Management</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="console-page">
    <section class="console-hero">
      <div>
        <p class="console-eyebrow">Team Operations</p>
        <h1>Staff management</h1>
        <p>
          Manage approved team members through a scoped roster. Filter by location, role, and status,
          then edit people without navigating an org tree.
        </p>
      </div>
      <div class="console-meta">
        <span class="console-pill">{{ managedUsers().length }} managed user(s)</span>
        <span class="console-pill">{{ directorySummary() }}</span>
      </div>
    </section>

    <ion-card class="console-card">
      <ion-card-header>
        <ion-card-title>Directory Filters</ion-card-title>
        <p class="section-copy">Reduce the roster to the exact scope you want to work on.</p>
      </ion-card-header>
      <ion-card-content>
        <div class="form-grid roster-filters">
          @if (showGroupFilter()) {
            <ion-item class="field-item">
              <ion-label position="stacked">Hotel Group</ion-label>
              <ion-select
                [value]="selectedGroupId()"
                (ionChange)="setGroupFilter($event.detail.value ?? null)"
                interface="alert"
              >
                <ion-select-option [value]="null">All groups</ion-select-option>
                @for (group of visibleGroupOptions(); track group.id ?? group.name) {
                  <ion-select-option [value]="group.id ?? null">{{ group.name }}</ion-select-option>
                }
              </ion-select>
            </ion-item>
          }

          @if (showHotelFilter()) {
            <ion-item class="field-item">
              <ion-label position="stacked">Hotel</ion-label>
              <ion-select
                [value]="selectedHotelId()"
                (ionChange)="setHotelFilter($event.detail.value ?? null)"
                interface="alert"
              >
                <ion-select-option [value]="null">All hotels</ion-select-option>
                @for (hotel of visibleHotelOptions(); track hotel.id ?? hotel.name) {
                  <ion-select-option [value]="hotel.id ?? null">{{ hotel.name }}</ion-select-option>
                }
              </ion-select>
            </ion-item>
          }

          <ion-item class="field-item">
            <ion-label position="stacked">Role</ion-label>
            <ion-select
              [value]="roleFilter()"
              (ionChange)="setRoleFilter($event.detail.value)"
              interface="alert"
            >
              <ion-select-option value="ALL">All roles</ion-select-option>
              @if (showPlatformSection()) {
                <ion-select-option value="SUPERADMIN">Superadmins</ion-select-option>
              }
              <ion-select-option value="HOTEL_GROUP_ADMIN">Group admins</ion-select-option>
              <ion-select-option value="HOTEL_ADMIN">Hotel admins</ion-select-option>
              <ion-select-option value="STAFF">Staff</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item class="field-item">
            <ion-label position="stacked">Status</ion-label>
            <ion-select
              [value]="statusFilter()"
              (ionChange)="setStatusFilter($event.detail.value)"
              interface="alert"
            >
              <ion-select-option value="ALL">All status</ion-select-option>
              <ion-select-option value="ACTIVE">Active</ion-select-option>
              <ion-select-option value="DISABLED">Disabled</ion-select-option>
            </ion-select>
          </ion-item>
        </div>

        <div class="form-actions">
          <ion-button type="button" fill="clear" (click)="refreshAll()">Refresh</ion-button>
          <ion-button type="button" fill="outline" (click)="clearFilters()">Clear filters</ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    @if (error()) {
      <ion-card class="console-card">
        <ion-card-content>
          <p class="error-text">{{ error() }}</p>
        </ion-card-content>
      </ion-card>
    }

    @if (loading()) {
      <ion-card class="console-card">
        <ion-card-content>
          <p class="empty-text">Loading...</p>
        </ion-card-content>
      </ion-card>
    } @else {
      @if (showPlatformSection()) {
        <section class="roster-section">
          <div class="section-intro">
            <div>
              <p class="console-eyebrow">Platform</p>
              <h2>Superadmins</h2>
            </div>
            <p class="section-count">{{ rosterSummary(platformUsers(), 'Superadmins') }}</p>
          </div>

          <div class="roster-grid">
            @for (user of platformUsers(); track user.id ?? user.firebaseUid) {
              <ng-container
                [ngTemplateOutlet]="personCard"
                [ngTemplateOutletContext]="{ $implicit: user }"
              />
            } @empty {
              <p class="empty-text">No superadmins match the current filters.</p>
            }
          </div>
        </section>
      }

      <section class="roster-section">
        <div class="section-intro">
          <div>
            <p class="console-eyebrow">Leadership</p>
            <h2>Group Admins</h2>
          </div>
          <p class="section-count">{{ rosterSummary(groupAdmins(), 'Group admins') }}</p>
        </div>

        <div class="roster-grid">
          @for (user of groupAdmins(); track user.id ?? user.firebaseUid) {
            <ng-container
              [ngTemplateOutlet]="personCard"
              [ngTemplateOutletContext]="{ $implicit: user }"
            />
          } @empty {
            <p class="empty-text">No group admins match the current filters.</p>
          }
        </div>
      </section>

      <section class="roster-section">
        <div class="section-intro">
          <div>
            <p class="console-eyebrow">Leadership</p>
            <h2>Hotel Admins</h2>
          </div>
          <p class="section-count">{{ rosterSummary(hotelAdmins(), 'Hotel admins') }}</p>
        </div>

        <div class="roster-grid">
          @for (user of hotelAdmins(); track user.id ?? user.firebaseUid) {
            <ng-container
              [ngTemplateOutlet]="personCard"
              [ngTemplateOutletContext]="{ $implicit: user }"
            />
          } @empty {
            <p class="empty-text">No hotel admins match the current filters.</p>
          }
        </div>
      </section>

      <section class="roster-section">
        <div class="section-intro">
          <div>
            <p class="console-eyebrow">Operations</p>
            <h2>Staff</h2>
          </div>
          <p class="section-count">{{ rosterSummary(staffUsers(), 'Staff') }}</p>
        </div>

        <div class="roster-grid">
          @for (user of staffUsers(); track user.id ?? user.firebaseUid) {
            <ng-container
              [ngTemplateOutlet]="personCard"
              [ngTemplateOutletContext]="{ $implicit: user }"
            />
          } @empty {
            <p class="empty-text">No staff match the current filters.</p>
          }
        </div>
      </section>
    }
  </div>
</ion-content>

<ng-template #personCard let-user>
  <article class="console-record roster-card">
    <div class="record-heading">
      <div>
        <h3>{{ user.name }}</h3>
        <p>{{ user.email }}</p>
      </div>
      <div class="record-metadata record-metadata-tight">
        <span class="console-pill">{{ userRoleLabel(user) }}</span>
        <span class="console-pill">{{ (user.active ?? true) ? 'Active' : 'Disabled' }}</span>
      </div>
    </div>

    <div class="record-metadata record-metadata-compact">
      @if (user.phone) {
        <span class="console-pill">Phone: {{ user.phone }}</span>
      }
      <span class="console-pill">Group: {{ user.assignedHotelGroup?.name || '-' }}</span>
      <span class="console-pill">Hotel: {{ user.assignedHotel?.name || '-' }}</span>
    </div>

    <div class="inline-actions inline-actions-compact">
      <ion-button type="button" fill="outline" class="inline-neutral" size="small" (click)="toggleEditor(user.id)">
        {{ expandedUserId() === user.id ? 'Close editor' : 'Edit member' }}
      </ion-button>
    </div>

    @if (user.id != null && expandedUserId() === user.id) {
      <div class="staff-grid">
        <ion-item class="field-item">
          <ion-label position="stacked">Name</ion-label>
          <ion-input
            [(ngModel)]="drafts[user.id].name"
            [ngModelOptions]="{ standalone: true }"
          />
        </ion-item>

        <ion-item class="field-item">
          <ion-label position="stacked">Phone</ion-label>
          <ion-input
            [(ngModel)]="drafts[user.id].phone"
            [ngModelOptions]="{ standalone: true }"
          />
        </ion-item>

        <ion-item class="field-item">
          <ion-label position="stacked">Access Role</ion-label>
          <ion-select
            [(ngModel)]="drafts[user.id].accessRole"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onRoleChange(user.id)"
            interface="alert"
          >
            @for (role of roleOptionsForUser(); track role) {
              <ion-select-option [value]="role">{{ role.replaceAll('_', ' ') }}</ion-select-option>
            }
          </ion-select>
        </ion-item>

        @if (needsGroupAssignment(drafts[user.id].accessRole)) {
          <ion-item class="field-item">
            <ion-label position="stacked">Assigned Hotel Group</ion-label>
            <ion-select
              [(ngModel)]="drafts[user.id].assignedHotelGroupId"
              [ngModelOptions]="{ standalone: true }"
              interface="alert"
            >
              <ion-select-option [value]="null">Select group</ion-select-option>
              @for (group of assignableHotelGroups(); track group.id ?? group.name) {
                <ion-select-option [value]="group.id ?? null">
                  {{ group.name }}{{ group.code ? ' (' + group.code + ')' : '' }}
                </ion-select-option>
              }
            </ion-select>
          </ion-item>
        }

        @if (needsHotelAssignment(drafts[user.id].accessRole)) {
          <ion-item class="field-item">
            <ion-label position="stacked">Assigned Hotel</ion-label>
            <ion-select
              [(ngModel)]="drafts[user.id].assignedHotelId"
              [ngModelOptions]="{ standalone: true }"
              interface="alert"
            >
              <ion-select-option [value]="null">Select hotel</ion-select-option>
              @for (hotel of filteredHotelsForUser(user.id); track hotel.id ?? hotel.name) {
                <ion-select-option [value]="hotel.id ?? null">
                  {{ hotel.name }}{{ hotel.code ? ' (' + hotel.code + ')' : '' }}
                </ion-select-option>
              }
            </ion-select>
          </ion-item>
        }

        @if (needsEmployeeRole(drafts[user.id].accessRole)) {
          <ion-item class="field-item">
            <ion-label position="stacked">Operational Role</ion-label>
            <ion-select
              [(ngModel)]="drafts[user.id].employeeRole"
              [ngModelOptions]="{ standalone: true }"
              interface="alert"
            >
              <ion-select-option [value]="null">Select role</ion-select-option>
              @for (role of employeeRoles; track role) {
                <ion-select-option [value]="role">{{ role.replaceAll('_', ' ') }}</ion-select-option>
              }
            </ion-select>
          </ion-item>
        }

        <ion-item class="checkbox-item">
          <ion-checkbox
            slot="start"
            type="checkbox"
            [(ngModel)]="drafts[user.id].active"
            [ngModelOptions]="{ standalone: true }"
          />
          <ion-label>Access Active</ion-label>
        </ion-item>

        <div class="form-actions span-2">
          <ion-button type="button" [disabled]="isBusy(user.id)" (click)="save(user)">
            Save Changes
          </ion-button>
          <ion-button
            type="button"
            fill="outline"
            [disabled]="isBusy(user.id)"
            (click)="toggleEditor(user.id)"
          >
            Cancel
          </ion-button>
        </div>
      </div>
    }
  </article>
</ng-template>
