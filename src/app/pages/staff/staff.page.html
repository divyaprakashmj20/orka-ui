<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/" />
    </ion-buttons>
    <ion-title>Staff Management</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="console-page">
    <section class="console-hero">
      <div>
        <p class="console-eyebrow">Team Operations</p>
        <h1>Staff management</h1>
        <p>
          Manage active team members after approval. Update role, access scope, operational role,
          and activation status without mixing this into the approval queue.
        </p>
      </div>
      <div class="console-meta">
        <span class="console-pill">{{ managedUsers().length }} managed user(s)</span>
      </div>
    </section>

    <ion-card class="console-card">
      <ion-card-header>
        <ion-card-title>Active Team Directory</ion-card-title>
        <p class="section-copy">Only users inside your current scope are shown here.</p>
      </ion-card-header>
      <ion-card-content>
        <div class="console-toolbar">
          <div class="console-meta console-meta-filters">
            <span class="console-pill">Scoped by current role</span>
            <div class="filter-group">
              <button
                type="button"
                class="filter-chip"
                [class.active]="roleFilter() === 'ALL'"
                (click)="setRoleFilter('ALL')"
              >
                All roles
              </button>
              <button
                type="button"
                class="filter-chip"
                [class.active]="roleFilter() === 'HOTEL_GROUP_ADMIN'"
                (click)="setRoleFilter('HOTEL_GROUP_ADMIN')"
              >
                Group admins
              </button>
              <button
                type="button"
                class="filter-chip"
                [class.active]="roleFilter() === 'HOTEL_ADMIN'"
                (click)="setRoleFilter('HOTEL_ADMIN')"
              >
                Hotel admins
              </button>
              <button
                type="button"
                class="filter-chip"
                [class.active]="roleFilter() === 'STAFF'"
                (click)="setRoleFilter('STAFF')"
              >
                Staff
              </button>
            </div>
            <div class="filter-group">
              <button
                type="button"
                class="filter-chip"
                [class.active]="statusFilter() === 'ALL'"
                (click)="setStatusFilter('ALL')"
              >
                All status
              </button>
              <button
                type="button"
                class="filter-chip"
                [class.active]="statusFilter() === 'ACTIVE'"
                (click)="setStatusFilter('ACTIVE')"
              >
                Active
              </button>
              <button
                type="button"
                class="filter-chip"
                [class.active]="statusFilter() === 'DISABLED'"
                (click)="setStatusFilter('DISABLED')"
              >
                Disabled
              </button>
            </div>
          </div>
          <div class="form-actions">
            <ion-button type="button" fill="clear" (click)="refreshAll()">Refresh</ion-button>
          </div>
        </div>

        @if (error()) {
          <p class="error-text">{{ error() }}</p>
        }

        @if (loading()) {
          <p class="empty-text">Loading...</p>
        } @else {
          <div class="tree-root">
            @if (showPlatformSection() && platformUsers().length) {
              <section class="tree-section">
                <div class="tree-branch tree-branch-root">
                  <button type="button" class="tree-toggle tree-node tree-node-root" (click)="togglePlatform()">
                    <div class="tree-toggle-copy">
                      <p class="node-eyebrow">Platform</p>
                      <h3>Superadmins</h3>
                      <p>{{ platformUsers().length }} account(s) with platform-wide control.</p>
                    </div>
                    <span class="tree-toggle-state">
                      <span class="tree-toggle-arrow">{{ platformExpanded() ? '−' : '+' }}</span>
                      {{ platformExpanded() ? 'Hide' : 'Show' }}
                    </span>
                  </button>

                  @if (platformExpanded()) {
                    <div class="tree-children">
                      @for (user of platformUsers(); track user.id ?? user.firebaseUid) {
                        <ng-container
                          [ngTemplateOutlet]="personCard"
                          [ngTemplateOutletContext]="{ $implicit: user }"
                        />
                      }
                    </div>
                  }
                </div>
              </section>
            }

            @for (groupNode of groupNodes(); track groupNode.group.id ?? groupNode.group.name) {
              <section class="tree-section">
                <div class="tree-branch tree-branch-root">
                  <button
                    type="button"
                    class="tree-toggle tree-node tree-node-root"
                    (click)="toggleGroup(groupNode.group.id)"
                  >
                    <div class="tree-toggle-copy">
                      <p class="node-eyebrow">Hotel Group</p>
                      <h3>{{ groupNode.group.name }}</h3>
                      <p>{{ groupSummary(groupNode) }}</p>
                    </div>
                    <span class="tree-toggle-state">
                      <span class="tree-toggle-arrow">{{ isGroupExpanded(groupNode.group.id) ? '−' : '+' }}</span>
                      {{ isGroupExpanded(groupNode.group.id) ? 'Hide' : 'Show' }}
                    </span>
                  </button>

                  @if (isGroupExpanded(groupNode.group.id)) {
                    <div class="tree-children tree-children-surface">
                      @if (showGroupLeadershipSection()) {
                        <div class="tree-branch">
                          <div class="tree-node tree-node-role">
                            <p class="node-eyebrow">Group Leadership</p>
                            <h4>Group Admins</h4>
                            <p>{{ groupNode.groupAdmins.length }} account(s)</p>
                          </div>

                          <div class="tree-children tree-people">
                            @for (user of groupNode.groupAdmins; track user.id ?? user.firebaseUid) {
                              <ng-container
                                [ngTemplateOutlet]="personCard"
                                [ngTemplateOutletContext]="{ $implicit: user }"
                              />
                            } @empty {
                              <p class="empty-text">No group admins assigned.</p>
                            }
                          </div>
                        </div>
                      }

                      @for (hotelNode of groupNode.hotels; track hotelNode.hotel.id ?? hotelNode.hotel.name) {
                        <div class="tree-branch">
                          <button
                            type="button"
                            class="tree-toggle tree-node tree-node-hotel"
                            (click)="toggleHotel(hotelNode.hotel.id)"
                          >
                            <div class="tree-toggle-copy">
                              <p class="node-eyebrow">Hotel</p>
                              <h4>{{ hotelNode.hotel.name }}</h4>
                              <p>{{ hotelSummary(hotelNode) }}</p>
                            </div>
                            <span class="tree-toggle-state">
                              <span class="tree-toggle-arrow">{{ isHotelExpanded(hotelNode.hotel.id) ? '−' : '+' }}</span>
                              {{ isHotelExpanded(hotelNode.hotel.id) ? 'Hide' : 'Show' }}
                            </span>
                          </button>

                          @if (isHotelExpanded(hotelNode.hotel.id)) {
                            <div class="tree-children tree-children-surface">
                              @if (showHotelAdminSection()) {
                                <div class="tree-branch">
                                  <div class="tree-node tree-node-role">
                                    <p class="node-eyebrow">Leadership</p>
                                    <h5>Hotel Admins</h5>
                                    <p>{{ hotelNode.hotelAdmins.length }} account(s)</p>
                                  </div>

                                  <div class="tree-children tree-people">
                                    @for (user of hotelNode.hotelAdmins; track user.id ?? user.firebaseUid) {
                                      <ng-container
                                        [ngTemplateOutlet]="personCard"
                                        [ngTemplateOutletContext]="{ $implicit: user }"
                                      />
                                    } @empty {
                                      <p class="empty-text">No hotel admins assigned.</p>
                                    }
                                  </div>
                                </div>
                              }

                              <div class="tree-branch">
                                <div class="tree-node tree-node-role">
                                  <p class="node-eyebrow">Operations</p>
                                  <h5>Staff</h5>
                                  <p>{{ hotelNode.staff.length }} account(s)</p>
                                </div>

                                <div class="tree-children tree-people">
                                  @for (user of hotelNode.staff; track user.id ?? user.firebaseUid) {
                                    <ng-container
                                      [ngTemplateOutlet]="personCard"
                                      [ngTemplateOutletContext]="{ $implicit: user }"
                                    />
                                  } @empty {
                                    <p class="empty-text">No staff assigned.</p>
                                  }
                                </div>
                              </div>
                            </div>
                          }
                        </div>
                      } @empty {
                        <p class="empty-text">No hotels are visible inside this group yet.</p>
                      }
                    </div>
                  }
                </div>
              </section>
            } @empty {
              @if (!platformUsers().length) {
                <p class="empty-text">No approved users are available inside your scope.</p>
              }
            }
          </div>
        }
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>

<ng-template #personCard let-user>
  <article class="console-record tree-person">
    <div class="record-heading">
      <div>
        <h3>{{ user.name }}</h3>
        <p>{{ user.email }}</p>
      </div>
      <div class="record-metadata record-metadata-tight">
        <span class="console-pill">{{ userRoleLabel(user) }}</span>
        <span class="console-pill">
          {{ (user.active ?? true) ? 'Active' : 'Disabled' }}
        </span>
      </div>
    </div>

    <div class="record-metadata record-metadata-compact">
      @if (user.phone) {
        <span class="console-pill">Phone: {{ user.phone }}</span>
      }
      <span class="console-pill">Group: {{ user.assignedHotelGroup?.name || '-' }}</span>
      <span class="console-pill">Hotel: {{ user.assignedHotel?.name || '-' }}</span>
    </div>

    <div class="inline-actions inline-actions-compact">
      <button type="button" (click)="toggleEditor(user.id)">
        {{ expandedUserId() === user.id ? 'Close editor' : 'Edit staff member' }}
      </button>
    </div>

    @if (user.id != null && expandedUserId() === user.id) {
      <div class="staff-grid">
        <label>
          <span>Name</span>
          <input
            [(ngModel)]="drafts[user.id].name"
            [ngModelOptions]="{ standalone: true }"
          />
        </label>

        <label>
          <span>Phone</span>
          <input
            [(ngModel)]="drafts[user.id].phone"
            [ngModelOptions]="{ standalone: true }"
          />
        </label>

        <label>
          <span>Access Role</span>
          <select
            [(ngModel)]="drafts[user.id].accessRole"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onRoleChange(user.id)"
          >
            @for (role of roleOptionsForUser(); track role) {
              <option [ngValue]="role">{{ role.replaceAll('_', ' ') }}</option>
            }
          </select>
        </label>

        @if (needsGroupAssignment(drafts[user.id].accessRole)) {
          <label>
            <span>Assigned Hotel Group</span>
            <select
              [(ngModel)]="drafts[user.id].assignedHotelGroupId"
              [ngModelOptions]="{ standalone: true }"
            >
              <option [ngValue]="null">Select group</option>
              @for (group of assignableHotelGroups(); track group.id ?? group.name) {
                <option [ngValue]="group.id ?? null">
                  {{ group.name }}{{ group.code ? ' (' + group.code + ')' : '' }}
                </option>
              }
            </select>
          </label>
        }

        @if (needsHotelAssignment(drafts[user.id].accessRole)) {
          <label>
            <span>Assigned Hotel</span>
            <select
              [(ngModel)]="drafts[user.id].assignedHotelId"
              [ngModelOptions]="{ standalone: true }"
            >
              <option [ngValue]="null">Select hotel</option>
              @for (hotel of filteredHotelsForUser(user.id); track hotel.id ?? hotel.name) {
                <option [ngValue]="hotel.id ?? null">
                  {{ hotel.name }}{{ hotel.code ? ' (' + hotel.code + ')' : '' }}
                </option>
              }
            </select>
          </label>
        }

        @if (needsEmployeeRole(drafts[user.id].accessRole)) {
          <label>
            <span>Operational Role</span>
            <select
              [(ngModel)]="drafts[user.id].employeeRole"
              [ngModelOptions]="{ standalone: true }"
            >
              <option [ngValue]="null">Select role</option>
              @for (role of employeeRoles; track role) {
                <option [ngValue]="role">{{ role.replaceAll('_', ' ') }}</option>
              }
            </select>
          </label>
        }

        <label class="toggle-label">
          <span>Access Active</span>
          <input
            type="checkbox"
            [(ngModel)]="drafts[user.id].active"
            [ngModelOptions]="{ standalone: true }"
          />
        </label>

        <div class="form-actions span-2">
          <ion-button type="button" [disabled]="isBusy(user.id)" (click)="save(user)">
            Save Changes
          </ion-button>
          <ion-button
            type="button"
            fill="outline"
            [disabled]="isBusy(user.id)"
            (click)="toggleEditor(user.id)"
          >
            Cancel
          </ion-button>
        </div>
      </div>
    }
  </article>
</ng-template>
